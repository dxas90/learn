name: KinD Deployment
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
env:
  APP_IMAGE: dxas90/learn
jobs:
  deploy-n-k8s:
    name: "Deploy to KinD with E2E Testing"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Kind Cluster
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.29.0
          kubectl_version: v1.30.4
          cluster_name: test-cluster-1
          verbosity: 1
          
      - name: "Build and Load Docker Image"
        run: |
          export LAST_COMMIT_HASH="${GITHUB_SHA::7}"
          export APP_NAME=learn
          echo "Building Docker image..."
          docker build -t ${APP_IMAGE}:${LAST_COMMIT_HASH} .
          docker tag ${APP_IMAGE}:${LAST_COMMIT_HASH} ${APP_IMAGE}:latest
          echo "Loading image into KinD cluster..."
          kind load docker-image ${APP_IMAGE}:latest --name test-cluster-1
          
      - name: "Deploy to KinD"
        id: deploy
        run: |
          export LAST_COMMIT_HASH="${GITHUB_SHA::7}"
          export APP_NAME=learn
          echo "waiting for nodes to be ready ..."
          kubectl wait --for=condition=Ready nodes --all --timeout=5m
          echo "nodes ..."
          kubectl get nodes
          echo "cluster-info ..."
          kubectl cluster-info
          echo "Deploying application..."
          kubectl apply -k k8s
          echo "waiting for pods to be ready ..."
          kubectl wait --for=condition=Ready pods --all --timeout=5m
          kubectl get pods
          
      - name: "Run Smoke Test"
        run: |
          echo "Running quick smoke test..."
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh
          
      - name: "Run Comprehensive E2E Tests"
        run: |
          echo "Starting comprehensive end-to-end testing..."
          chmod +x scripts/e2e-test.sh
          ./scripts/e2e-test.sh
          
      - name: "Run WebSocket Tests"
        run: |
          echo "Starting WebSocket testing..."
          chmod +x scripts/websocket-test.sh
          ./scripts/websocket-test.sh
          
      - name: "Validate Deployment Health"
        run: |
          echo "Final deployment health check..."
          kubectl get all
          kubectl describe deployment learn
          
          # Check if all pods are healthy
          UNHEALTHY_PODS=$(kubectl get pods --field-selector=status.phase!=Running --no-headers | wc -l)
          if [ "$UNHEALTHY_PODS" -gt 0 ]; then
            echo "Found unhealthy pods:"
            kubectl get pods --field-selector=status.phase!=Running
            exit 1
          fi
          
          echo "âœ… All deployment health checks passed!"
          
      - name: "Collect Logs and Debug Info"
        if: failure()
        run: |
          echo "=== COLLECTING DEBUG INFORMATION ==="
          echo "--- Cluster Information ---"
          kubectl cluster-info
          kubectl get nodes -o wide
          
          echo "--- All Resources ---"
          kubectl get all -o wide
          
          echo "--- Pod Descriptions ---"
          kubectl describe pods
          
          echo "--- Pod Logs ---"
          for pod in $(kubectl get pods -o name); do
            echo "=== Logs for $pod ==="
            kubectl logs $pod --all-containers=true || true
          done
          
          echo "--- Events ---"
          kubectl get events --sort-by='.metadata.creationTimestamp'